---
title: 'Spatial considerations in the analysis of conservation data: evaluating the presence  of \textit{Acer campestre} (field maple) – space is special'
author: "Alexis Comber^1^, Steve Carver^1^, Paul Harris^2^, Duccio Rocchini^3^"
output: pdf_document
geometry: margin=3cm
---

^1^ School of Geography, University of Leeds, Leeds, LS2 9JT, UK

Email: {a.comber; s.j.carver} @leeds.ac.uk 

^2^ Rothamsted Research, North Wyke, EX20 2SB, UK

Email: paul.harris@rothamsted.ac.uk

^3^ Fondazione Edmund Mach, 38010 S. Michele all'Adige, Italy 

Email: duccio.rocchini@fmach.it



```{r functions, include=FALSE}
# A function for captioning and referencing figures
fig <- local({
    i <- 0
    ref <- list()
    list(
        cap=function(refName, text) {
            i <<- i + 1
            ref[[refName]] <<- i
            paste( text, sep="")
        },
        ref=function(refName) {
            ref[[refName]]
        })
})
```




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract
TBC

# 1. Introduction
This paper emphasises the need for *Geography Googles* in applied geographical analyses of data that increasingly have a spatial comonent in the form of location, for instance form GPS. It argues that *space is special* and encourages explicitly spatial ways of thinking. These ideas are posited in the context of nearly all data being spatial (i.e location is included), and the need for slightly more informed approaches for analysing space and location than provided by standard statistical models. 

\textbf{Blah blah blah (Lex to complete but any suggestions welcome)}

The paper tests the model suggested by Coudun et al (2006) but does this using a Geographically Weighted (GW) frameworks (Brunsdon et al, 1996) such as GW Regression (GWR), a spatial dependence model. Coudun et al (2006) found the presence of *Acer campestre* in France to be significantly related to two factors rainfall and evapotranspiration. Here Coudon’s analysis is extended to account for spatial autocorrelation in the variables which occurs when changes in properties of nearby features are found to be correlated and this contradicts the underlying assumption of independence in statistical analysis and inference. The result is spatial non-stationarity when the statistical pattern or relationship observed in one location differs from that in another. To explore these, this paper applies a GWR analysis to examine the spatial variation in the relationships between the predictor variables and Acer campestre presence to test for the presence of local, non-stationary relationships.

# 2. Background

## 2.1 Need for explicitly spatial methods 
\textbf{TBC - Harry?}

- Need: location is not just another variable - Key concept in spatial statistics / quant geog
- Review: GWR Not the first – similar ideas found in: Crop science (Fischer & Gosset 1935), Meteorology (Kolmogorov 1941; Gandin 1965); Mining (Krige 1951; Matheron 1963); Forestry (Matérn 1960); Theory (Yaglom 1955); Euripides: *Slight not what’s near, though aiming for what is far*
- Spatial statistics paradigms: Geostatistical models; Spatial regression models; Spatial point process models; Spatial ecology models; Spatial movement (trajectories) models; Spatial interaction models; Geographically weighted models etc: Point is that you choose one according to: (i) spatial process, (ii) spatial data type, (iii) inferential framework & (iv) research objectives
- Very brief overview of the GWR paradigm – detail is in sections later? And extensions

## 2.2 Review of spatial methods in ecology and conservation 
\textbf{TBC - Duccio?}


# 3. Methods

```{r eval=T, echo=F, message=F, warning=F, cache = TRUE}
# you will only need to run the lines below after 
# you have installed the packages on your computer
library(GISTools)
library(rgdal)
library(GWmodel)
library(repmis)

# Part 1. load and prepare the data

# 1.1 load prepared data files
#source_data("https://github.com/lexcomber/SpEcolCons2016/blob/master/SpEcolCons.RData?raw=True")
load('~/Desktop/my_docs_mac/leeds_work/research/conservation/anal/SpEcolCons.RData')

# Acknowldgements Rainfall
# https://catalogue.ceh.ac.uk/documents/f2856ee8-da6e-4b67-bedb-590520c77b3c
# You must cite: Tanguy, M.; Dixon, H.; Prosdocimi, I.; Morris, D. G.; Keller, V. D. J. (2015). Gridded estimates of daily and monthly areal rainfall for the United Kingdom (1890-2014) [CEH-GEAR]. NERC Environmental Information Data Centre. http://doi.org/10.5285/f2856ee8-da6e-4b67-bedb-590520c77b3c

# Acknowldgements PET
#http://csi.cgiar.org/Aridity/
#Trabucco, A., and Zomer, R.J. 2009. Global Aridity Index (Global-Aridity) and Global Potential Evapo-Transpiration (Global-PET) Geospatial Database. CGIAR Consortium for Spatial Information. Published online, available from the CGIAR-CSI GeoPortal at: http://www.csi.cgiar.org.
# clip PET to OS

# Acknowledgement Wildness Quality Index
# Kuiters, A. T., van Eupen, M., Carver, S., Fisher, M., Kun, Z., & Vancura, V. (2011). Wilderness register and indicator for Europe. Final Report - http://ec.europa.eu/environment/nature/natura2000/wilderness/pdf/Wilderness_register_indicator.pdf   

# 1.2 interpolate the over OS 10k grid
# wqi at 1k 
# pet at 30 arc second (1k at equator) 
# rain at 1k 
# everything projected to OS

# Aggregate the single variable layers
wqi.agg <- aggregate(wqi[,1], os10, mean)
pet.agg <- aggregate(pet[,1], os10, mean)
rain.agg <- aggregate(rain[,1], os10, mean)

# convert to points
wqi.agg <- SpatialPointsDataFrame(coordinates(wqi.agg), 
	data = wqi.agg@data, proj4string = os.proj)
pet.agg <- SpatialPointsDataFrame(coordinates(pet.agg), 
	data = pet.agg@data, proj4string = os.proj)
rain.agg <- SpatialPointsDataFrame(coordinates(rain.agg), 
	data = rain.agg@data, proj4string = os.proj)

# Aggregate the rainfall data from 'data'
# define a summary function
year.func <- function(x){
	sum(x, na.rm=T)/mean(x, na.rm = T)
}
years <- sort(unique(data.sp$year))
res.vec <- matrix(data = 0, ncol = length(years), nrow = nrow(os10))
for (i in 1:length(years)){
	year.i <- years[i]
	index.i <- which(data.sp$year == year.i)
	data.i <- data.sp[index.i,]
	data.i <- spTransform(data.i, os.proj)
	agg.i <- aggregate(data.i["year"], os10, year.func)
	res.vec[, i] <- agg.i$year
}
colnames(res.vec) <- years
index <- is.na(res.vec)
res.vec[index] <- 0
# create the aggregated variable
tree.agg <- SpatialPointsDataFrame(os10, 
	data.frame(tree = rowSums(res.vec)), 
	proj4string = os.proj)

# Uncomment to check dimensions
# dim(wqi.agg)
# dim(rain.agg)
# dim(pet.agg)
# dim(tree.agg)

# 1.3 create a single dataset for use in the analyses
df <- data.frame(tree = tree.agg@data, pet = pet.agg@data, 
	rain = rain.agg@data, wqi = wqi.agg@data)

d.a <- SpatialPointsDataFrame(coordinates(os10), data = data.frame(df))
# summary(d.a)
# get rind of any NAs
index<- !is.na(rowSums(d.a@data))
d.a <- d.a[index,]
```

## 3.1 Data and Study Area

Data recorded between 1980 and 2010 describing the presence of *Acer campestre* was downloaded from GBIF using the `dismo` R package, and subsetted for the UK. The data contained 22,701 records whose spatial distribution are shown in Figure 1, with a median of `r summary(colSums(res.vec))[3]`  records per year, a 1st quartile of `r summary(colSums(res.vec))[2]`  and a `r summary(colSums(res.vec))[4]` quartile of 917 records. The data for all years were summed over Ordnance Survey 10km grids because of the uneven distribution in time and space. Potential alternative approaches including generating absence points, background data (Phillips et al. 2009) to charcaterise study area environments or pseudo-absences (eg VanDerWal et al., 2009), indicating where absences might occur. However, pseudo absence approaches require a number of assumptions and lack statistical methods for handling the overlap between presence and background points (Ward et al. 2009; Phillips and Elith, 2011), absence data may be biased and or incomplete (Kery et al., 2010) and background data approaches generate the same measures irrespective of where the species is observed (Hijmans and Elith, 2015). 


```{r, fig.width=9, echo = F, eval=T,  cache = T, message=F, warning=F, fig.cap=fig$cap("", "a) The raw data points with a transparency term to show density of points, and b) Data summed over OS 10km grid cells.")}
par(mfrow = c(1,2))
par(mar = c(0,0,1,0))
plot(os10m, lwd = 0.5)
plot(data.sp[os10m,], pch = 1, cex = 0.2, col = "#2525254C", add = T)
title("a)")
plot(os10m, lwd = 0.5)
sh <-auto.shading(d.a$tree[d.a$tree>0], n = 7, cols=brewer.pal(7,'Reds'))
sh$breaks <- c(1,5,10,20,30,50)
choropleth(d.a, v = d.a$tree, sh, pch = 19, cex = 0.4, add = T)
choro.legend(px = "topright", sh = sh, title("Trees per 10km sq"), cex = 0.7)
title("b)")
```


The study by Coudun et al (2006) found the presence of *Acer campestre* to be significantly related to Autumn rainfall and actual Thornthwaite evapotranspiration. In this study rainfall, Potential evapotranspiration (PET) and wildness index data were used to construct a series of models for predicting the density of *Acer campestre* occurance. Data on rainfall were downloaded from the NERC Environmental Information Data Centre (Tanguy et al, 2015) which provides monthly 1km estimated rainfall data for each year. The average Autumn (3 month) rainfall was calculated for each 1km. Mean annual PET data were downloaded from the CGIAR Consortium for Spatial Information (Trabucco and Zomer, 2009) which provides global data at textbf\{0.0083 degrees, approximately 1km}. Finally, a wilder dataset was included in the model. This was to explore the degree to the presence of *Acer campestre* may be related to anthropogenic disturbance – anecdotally this species is frequently found in field margins and hedges. The Wilderness Quality Index data were generated for the whole of Europe at 1km resolution as described in Kuiters et al (2011) and can be considered as measure of non-anthropogenic activity. Each of these datasets were spatially aggregated over the OS 10m grid cells to generate mean values as shown in Figure 2. 

```{r, fig.width=9, echo = F, eval=T,  cache = T, message=F, warning=F, fig.cap=fig$cap("", "The data used to construct the species model, a) mean monthly Autumn Rain (mm), b) mean annual potential evapotranspiration (PET), and c)  Mean Wildness Quality Index.")}
par(mfrow = c(1,3))
par(mar = c(0,0,1,0))

plot(os10m, lwd = 0.5)
sh <-auto.shading(d.a$rain[d.a$rain > 0 ], n = 7,
	cols=brewer.pal(7,'Blues'))
choropleth(d.a, v = d.a$rain, sh, pch = 19, cex = 0.3, add = T)
choro.legend(px = "topright", sh = sh, cex = 1)
title("a)", cex.main = 1.5)

plot(os10m, lwd = 0.5)
sh <-auto.shading(d.a$pet[!is.na(d.a$pet)], n = 7,
	cols=brewer.pal(7,'YlOrRd'))
choropleth(d.a, v = d.a$pet, sh, pch = 19, cex = 0.3, add = T)
choro.legend(px = "topright", sh = sh, cex = 1)
title("b)", cex.main = 1.5)

plot(os10m, lwd = 0.5)
sh <-auto.shading(d.a$wqi[!is.na(d.a$wqi)], n = 7,
	cols=brewer.pal(7,'GnBu'))
choropleth(d.a, v = d.a$wqi, sh, pch = 19, cex = 0.3, add = T)
choro.legend(px = "topright", sh = sh, cex = 1)
title("c)", cex.main = 1.5)
```

## 3.2 Analysis

A multi-stage analysis was applied to model Acer campestre distributions. First, exploratory analyses were undertaken using a standard OLS regression to model distributions as an initial step. This identified significant predictor variables, under the assumption that relationships between predictor variables (rainfall, PET and wilderness) and species distributions are stationary (i.e. global). Then a GWR analysis was applied to examine the spatial variation in the relationships between the predictor variables and *Acer campestre* distributions (i.e. to test for the presence of local, non-stationary relationships). In overview, GW approaches use a moving window or kernel that passes through the study area. At each location being considered, data under the window are used to make a local calculation of some kind, such as a regression. The data are weighted by their distance to the kernel centre and in this way GW approaches construct a series of models at discrete locations in the study area. This is in contrast to global models, that consider all of the data (usually) in a single analysis of all data in the study area. 

Next, the presence of local collinearity amongst the predictor variables was tested. This is a critical step in any GWR analysis but one that is usually overlooked. Collinearity occurs when variables exhibit linear or near linear relationships. Strong collinearity will affect model reliability and precision, generate unstable parameter estimates, inflated standard errors and inferential biases (Dormann et al 2013), and there may be problems in separating variable effects (Meloun et al. 2002). In a GWR analyses, collinearity may occur locally, with the construction of localised regressions, even when it is not observed globally (Wheeler and Tiefelsdorf, 2005; Wheeler 2007, 2009, 2013; Brunsdon et al 2012). A number of approaches exist to address collinearity in regression modelling, such as partial least squares regression, principal component analysis regression and ridge regression (Hoerl 1962; Hoerl and Kennard 1970). Ridge regression is a penalised model where extensions, such as the lasso and the elastic net also provide predictor variable sub-set selection (e.g. Zou and Hastie 2005). All such models could be adapted to a localised form and Wheeler (2007; 2009) has proposed both ridge and lasso versions of GWR to address any detrimental local collinearity effects. A related, locally-compensated ridge GWR model is detailed in Brunsdon et al (2012), Lu et al. (2014b) and Gollini et al (2015). It has advantages over the ridge GWR model of Wheeler (2007) in that a ridge term is applied locally and not globally. These studies also describe associated local collinearity diagnostics for GWR, such as the use of local correlations amongst pairs of predictors, local Variance Inflation Factors (VIFs) for each predictor, local variance decomposition proportions (VDPs) and the local condition numbers (CNs). The key point about locally-compensated ridge GWR, is that a local ridge term is only applied where it is needed – when the local CN is above a pre-specified value in this case 30, which is a standard heuristic. 

This study undertakes a GWR analysis, with a locally-compensated ridge term if necessary, over a 200m grid of points covering the study area, with the aim of examining the spatial distribution of coefficient estimates predicting house price and their spatial variation. Euclidean distances were used to weight data points under the kernel. These distances better reflect the spatial processes and relationships in environmental systems than network distance (Comber et al., 2008). For the kernel, an adaptive bi-square weighting function was applied, although a number of kernel functions can be specified for GW models as discussed in Gollini et al (2015). 
This generates higher weights at locations very near to the kernel centre relative to those towards the edge. For each data point ($P_j$) under the kernel (with a given bandwidth), a weight $w_{i,j}$ is calculated based on its distance to the centre of the kernel ($K_{i}$) as follows:

\begin{center}
\begin{equation}
w_{i,j} = 1 - ((d_{i,j})^2 / b^2)
\end{equation}
\end{center}
where $d_{i,j}$ is the distance in metres from the centre of the kernel $K_i$ to the data point $P_j$ and $b$ is the bandwidth. 

An optimum kernel bandwidth for GWR can be found by minimising a model fit diagnostic. Options include a leave-one-out cross-validation (CV) score (Bowman 1984; Brunsdon et al. 1996). This optimises model prediction accuracy and the Akaike Information Criterion (AIC) (Akaike 1973; Fotheringham et al. 2002) optimises model parsimony by trading off prediction accuracy and complexity. In this case, the CV approach was applied to specify all GWR models, all using the bi-square weighting kernel and distances between locations. 

The standard GWR model is:

\begin{center}
\begin{equation}
y_{i} = \beta_{i0} + \sum_{m}^{k=1}\beta_{ik}x_{ik} + \epsilon_i 
\end{equation}
\end{center}

where $y_i$ is the response variable at location $i$, $x_{ik}$ is the value of the kth predictor variable at location $i$, $m$ is the number of predictor variables, $\beta_{i0}$ is the intercept term at location $i$, $\beta_{ik}$ is the local regression coefficient for the $k^{th}$ predictor variable at location $i$ and $\epsilon_i$ is the random error at location $i$. The result of the weighting means that data nearer to the kernel centre make a greater contribution to the estimation of local regression coefficients at each local regression calibration point $i$.




## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
